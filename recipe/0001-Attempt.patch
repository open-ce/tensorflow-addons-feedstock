From 02626c6990db6f0993676b798cd3093255070a24 Mon Sep 17 00:00:00 2001
From: Nishidha Panpaliya <npanpa23in.ibm.com>
Date: Thu, 8 Jun 2023 05:31:50 +0000
Subject: [PATCH] Attempt

---
 WORKSPACE                                     | 14 ++++++
 build_deps/toolchains/gpu/cub.BUILD           |  2 +-
 build_deps/toolchains/gpu/cuda_configure.bzl  |  5 ++-
 tensorflow_addons/0001-Use-cub-2.1.0.patch    | 45 +++++++++++++++++++
 tensorflow_addons/custom_ops/layers/BUILD     |  1 +
 .../cc/kernels/correlation_cost_op_gpu.cu.cc  |  2 +-
 6 files changed, 65 insertions(+), 4 deletions(-)
 create mode 100644 tensorflow_addons/0001-Use-cub-2.1.0.patch

diff --git a/WORKSPACE b/WORKSPACE
index 2f44047..b4ad248 100644
--- a/WORKSPACE
+++ b/WORKSPACE
@@ -13,8 +13,22 @@ http_archive(
     urls = [
         "https://github.com/tensorflow/tensorflow/archive/refs/tags/v2.12.0.tar.gz",
     ],
+    patches = ["//tensorflow_addons:0001-Use-cub-2.1.0.patch"],
+    patch_args = ["-p1"],
 )
 
+http_archive(
+    name = "cub_archive",
+    build_file = "//build_deps/toolchains/gpu:cub.BUILD",
+    sha256 = "8ec47307f5e99379ac1cf6722cd5a24fc15b84b0f5361bebd453645a5e4bb34d",
+    strip_prefix = "cub-2.1.0",
+    urls = [
+        "https://storage.googleapis.com/mirror.tensorflow.org/github.com/NVlabs/cub/archive/2.1.0.zip",
+        "https://github.com/NVlabs/cub/archive/2.1.0.zip",
+    ],
+)
+
+cuda_configure(name = "local_config_cuda")
 load("@org_tensorflow//tensorflow:workspace3.bzl", "tf_workspace3")
 
 tf_workspace3()
diff --git a/build_deps/toolchains/gpu/cub.BUILD b/build_deps/toolchains/gpu/cub.BUILD
index cdc9e4f..d43077b 100644
--- a/build_deps/toolchains/gpu/cub.BUILD
+++ b/build_deps/toolchains/gpu/cub.BUILD
@@ -18,7 +18,7 @@ filegroup(
 cc_library(
     name = "cub",
     hdrs = if_cuda([":cub_header_files"]),
-    include_prefix = "gpu",
+#    include_prefix = "gpu",
     deps = [
         "@local_config_cuda//cuda:cuda_headers",
     ],
diff --git a/build_deps/toolchains/gpu/cuda_configure.bzl b/build_deps/toolchains/gpu/cuda_configure.bzl
index ba38c6b..ca16ecf 100644
--- a/build_deps/toolchains/gpu/cuda_configure.bzl
+++ b/build_deps/toolchains/gpu/cuda_configure.bzl
@@ -975,7 +975,7 @@ def _create_local_cuda_repository(repository_ctx):
     # Set up crosstool/
     cc = find_cc(repository_ctx)
     cc_fullpath = cc
-
+    print("*************CC full path: ", cc_fullpath)
     host_compiler_includes = _host_compiler_includes(repository_ctx, cc_fullpath)
 
     cuda_defines = {}
@@ -988,7 +988,8 @@ def _create_local_cuda_repository(repository_ctx):
     # TODO: when bazel stops adding '-B/usr/bin' by default, remove this
     #       flag from the CROSSTOOL completely (see
     #       https://github.com/bazelbuild/bazel/issues/5634)
-    cuda_defines["%{linker_bin_path_flag}"] = 'flag: "-B/usr/bin"'
+#    cuda_defines["%{linker_bin_path_flag}"] = 'flag: "-B/usr/bin"'
+#    print("****************Linker path: ", cuda_defines["%{linker_bin_path}"])
 
     cuda_defines["%{host_compiler_path}"] = "clang/bin/crosstool_wrapper_driver_is_not_gcc"
     cuda_defines["%{host_compiler_warnings}"] = ""
diff --git a/tensorflow_addons/0001-Use-cub-2.1.0.patch b/tensorflow_addons/0001-Use-cub-2.1.0.patch
new file mode 100644
index 0000000..7fd03f5
--- /dev/null
+++ b/tensorflow_addons/0001-Use-cub-2.1.0.patch
@@ -0,0 +1,45 @@
+From c27363c78f2df111f24b60f55ab309df7e07d9dc Mon Sep 17 00:00:00 2001
+From: Nishidha Panpaliya <npanpa23in.ibm.com>
+Date: Tue, 6 Jun 2023 12:59:35 +0000
+Subject: [PATCH] Use cub 2.1.0
+
+---
+ tensorflow/workspace2.bzl           | 6 +++---
+ third_party/gpus/cuda_configure.bzl | 4 ++--
+ 2 files changed, 5 insertions(+), 5 deletions(-)
+
+diff --git a/tensorflow/workspace2.bzl b/tensorflow/workspace2.bzl
+index 1261273bc92..2de592ebd87 100644
+--- a/tensorflow/workspace2.bzl
++++ b/tensorflow/workspace2.bzl
+@@ -693,9 +693,9 @@ def _tf_repositories():
+     tf_http_archive(
+         name = "cub_archive",
+         build_file = "//third_party:cub.BUILD",
+-        sha256 = "162514b3cc264ac89d91898b58450190b8192e2af1142cf8ccac2d59aa160dda",
+-        strip_prefix = "cub-1.9.9",
+-        urls = tf_mirror_urls("https://github.com/NVlabs/cub/archive/1.9.9.zip"),
++        sha256 = "8ec47307f5e99379ac1cf6722cd5a24fc15b84b0f5361bebd453645a5e4bb34d",
++        strip_prefix = "cub-2.1.0",
++        urls = tf_mirror_urls("https://github.com/NVlabs/cub/archive/2.1.0.zip"),
+     )
+ 
+     tf_http_archive(
+diff --git a/third_party/gpus/cuda_configure.bzl b/third_party/gpus/cuda_configure.bzl
+index 922d26deef9..644a75152ff 100644
+--- a/third_party/gpus/cuda_configure.bzl
++++ b/third_party/gpus/cuda_configure.bzl
+@@ -1176,8 +1176,8 @@ def _create_local_cuda_repository(repository_ctx):
+     )
+ 
+     cub_actual = "@cub_archive//:cub"
+-    if int(cuda_config.cuda_version_major) >= 11:
+-        cub_actual = ":cuda_headers"
++    #if int(cuda_config.cuda_version_major) >= 11:
++    #    cub_actual = ":cuda_headers"
+ 
+     repository_ctx.template(
+         "cuda/BUILD",
+-- 
+2.34.1
+
diff --git a/tensorflow_addons/custom_ops/layers/BUILD b/tensorflow_addons/custom_ops/layers/BUILD
index 44d8771..07b7019 100644
--- a/tensorflow_addons/custom_ops/layers/BUILD
+++ b/tensorflow_addons/custom_ops/layers/BUILD
@@ -18,6 +18,7 @@ custom_op_library(
         "cc/kernels/correlation_cost_op.h",
         "cc/kernels/correlation_cost_op_gpu.cu.cc",
     ],
+    copts = ["-Iexternal/cub_archive"],
 )
 
 custom_op_library(
diff --git a/tensorflow_addons/custom_ops/layers/cc/kernels/correlation_cost_op_gpu.cu.cc b/tensorflow_addons/custom_ops/layers/cc/kernels/correlation_cost_op_gpu.cu.cc
index 16b012a..722f317 100644
--- a/tensorflow_addons/custom_ops/layers/cc/kernels/correlation_cost_op_gpu.cu.cc
+++ b/tensorflow_addons/custom_ops/layers/cc/kernels/correlation_cost_op_gpu.cu.cc
@@ -17,7 +17,7 @@ limitations under the License.
 
 #define EIGEN_USE_GPU
 
-#include "gpu/cub/device/device_reduce.cuh"
+#include "cub/device/device_reduce.cuh"
 #include "tensorflow/core/framework/tensor.h"
 #include "tensorflow/core/framework/tensor_shape.h"
 #include "tensorflow/core/util/gpu_kernel_helper.h"
-- 
2.34.1

