From 416de9a000f438e8e3cfc5195486412dae92b966 Mon Sep 17 00:00:00 2001
From: Nishidha Panpaliya <npanpa23@in.ibm.com>
Date: Fri, 10 Jun 2022 15:22:49 +0000
Subject: [PATCH] Fixed cuda builds with gcc 11

---
 build_deps/toolchains/gpu/crosstool/CROSSTOOL.tpl         | 1 -
 .../toolchains/gpu/crosstool/cc_toolchain_config.bzl.tpl  | 3 +--
 .../clang/bin/crosstool_wrapper_driver_is_not_gcc.tpl     | 2 +-
 configure.py                                              | 8 ++++----
 4 files changed, 6 insertions(+), 8 deletions(-)

diff --git a/build_deps/toolchains/gpu/crosstool/CROSSTOOL.tpl b/build_deps/toolchains/gpu/crosstool/CROSSTOOL.tpl
index 1a13ac8..1ff366e 100644
--- a/build_deps/toolchains/gpu/crosstool/CROSSTOOL.tpl
+++ b/build_deps/toolchains/gpu/crosstool/CROSSTOOL.tpl
@@ -636,7 +636,6 @@ toolchain {
       action: "assemble"
       action: "preprocess-assemble"
       flag_group {
-        flag: "-B"
         flag: "external/local_config_cuda/crosstool/windows/msvc_wrapper_for_nvcc.py"
       }
     }
diff --git a/build_deps/toolchains/gpu/crosstool/cc_toolchain_config.bzl.tpl b/build_deps/toolchains/gpu/crosstool/cc_toolchain_config.bzl.tpl
index ba002b4..4277b50 100755
--- a/build_deps/toolchains/gpu/crosstool/cc_toolchain_config.bzl.tpl
+++ b/build_deps/toolchains/gpu/crosstool/cc_toolchain_config.bzl.tpl
@@ -898,7 +898,6 @@ def _impl(ctx):
                 flag_groups = [
                     flag_group(
                         flags = [
-                            "-B",
                             "external/local_config_cuda/crosstool/windows/msvc_wrapper_for_nvcc.py",
                         ],
                     ),
@@ -912,7 +911,7 @@ def _impl(ctx):
         flag_sets = [
             flag_set(
                 actions = all_link_actions,
-                flag_groups = [flag_group(flags = ["-B" + ctx.attr.linker_bin_path])],
+                #flag_groups = [flag_group(flags = [ctx.attr.linker_bin_path])],
             ),
         ],
     )
diff --git a/build_deps/toolchains/gpu/crosstool/clang/bin/crosstool_wrapper_driver_is_not_gcc.tpl b/build_deps/toolchains/gpu/crosstool/clang/bin/crosstool_wrapper_driver_is_not_gcc.tpl
index affc0be..3b5fd82 100644
--- a/build_deps/toolchains/gpu/crosstool/clang/bin/crosstool_wrapper_driver_is_not_gcc.tpl
+++ b/build_deps/toolchains/gpu/crosstool/clang/bin/crosstool_wrapper_driver_is_not_gcc.tpl
@@ -205,7 +205,7 @@ def InvokeNvcc(argv, log=False):
       x.replace(".", "") for x in supported_cuda_compute_capabilities])
   for capability in supported_cuda_compute_capabilities[:-1]:
     nvccopts += r'-gencode=arch=compute_%s,\"code=sm_%s\" ' % (
-        capability, capability, capability)
+        capability, capability)
   if supported_cuda_compute_capabilities:
     capability = supported_cuda_compute_capabilities[-1]
     nvccopts += r'-gencode=arch=compute_%s,code=\"sm_%s,compute_%s\" ' % (
diff --git a/configure.py b/configure.py
index 0d65e88..0904da9 100644
--- a/configure.py
+++ b/configure.py
@@ -184,10 +184,10 @@ def configure_cuda():
     write("test --config=cuda")
     write("build --config=cuda")
     write("build:cuda --define=using_cuda=true --define=using_cuda_nvcc=true")
-    write(
-        "build:cuda --crosstool_top=@ubuntu20.04-gcc9_manylinux2014-cuda11.2-cudnn8.1-tensorrt7.2_config_cuda//crosstool:toolchain"
-    )
-
+    #write(
+    #    "build:cuda --crosstool_top=@ubuntu20.04-gcc9_manylinux2014-cuda11.2-cudnn8.1-tensorrt7.2_config_cuda//crosstool:toolchain"
+    #)
+    write("build:cuda --crosstool_top=@local_config_cuda//crosstool:toolchain")
 
 if __name__ == "__main__":
     create_build_configuration()
-- 
2.34.1

